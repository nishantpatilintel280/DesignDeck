@page
@model EP.Pages.RolesModel
@{
    ViewData["Title"] = "Roles";
    Layout = "_Layout";
}

<div class="container-fluid py-5">
    @* Apply Access section visible only for read-only roles (Manager=5, Non GCE=3) *@
    @if (Model.CurrentRole == 5 || Model.CurrentRole == 3)
    {
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="h5 mb-0">Apply for Elevated Access</h2>
                    @{ var roleDesc = Model.CurrentRole switch { 1 => "Admin - complete access", 2 => "CE - Read and Write access", 4 => "Lead - Read and Write access", 5 => "Manager - Read access", 3 => "Non GCE - Read access", _ => "Unknown" }; }
                    <span class="badge bg-secondary">Current Role: @roleDesc</span>
                </div>
                <p class="text-muted">Request elevated access by selecting a role and sending your manager.</p>
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#applyAccessModal">
                    Apply Access
                </button>
            </div>
        </div>

        <!-- Modal: Apply Access -->
        <div class="modal fade" id="applyAccessModal" tabindex="-1" aria-labelledby="applyAccessModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="applyAccessModalLabel">Request Elevated Role</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="RequestedRoleModal" class="form-label">Select Role</label>
                            <select id="RequestedRoleModal" class="form-select" required>
                                <option value="" disabled selected>Select a role</option>
                                <option value="2">CE - Read and Write access</option>
                                <option value="4">Lead - Read and Write access</option>
                                <option value="1">Admin - complete access</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="ManagerEmailModal" class="form-label">Manager Email</label>
                            <input id="ManagerEmailModal" type="email" class="form-control" placeholder="manager@intel.com" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="sendAccessRequestBtn">Send Email</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            (function(){
                const btn = document.getElementById('sendAccessRequestBtn');
                if (!btn) return;
                btn.addEventListener('click', function(){
                    const roleSel = document.getElementById('RequestedRoleModal');
                    const mgrInput = document.getElementById('ManagerEmailModal');
                    const roleId = roleSel && roleSel.value ? roleSel.value : '';
                    const managerEmail = mgrInput && mgrInput.value ? mgrInput.value.trim() : '';
                    if (!roleId){ alert('Please select a role to request.'); return; }
                    if (!managerEmail){ alert('Please enter your manager\'s email.'); return; }
                    const roleName = (function(id){
                        switch(id){
                            case '1': return 'Admin - complete access';
                            case '2': return 'CE - Read and Write access';
                            case '4': return 'Lead - Read and Write access';
                            default: return 'Unknown';
                        }
                    })(roleId);
                    const userIdsid = '@Model.CurrentIdsid';
                    const currentRoleId = '@Model.CurrentRole';
                    const subject = encodeURIComponent(`[EP Access] Request elevated role: ${roleName}`);
                    const body = encodeURIComponent(
                        `Hello,\n\nI would like to request elevated access in EP.\n\n` +
                        `Idsid: ${userIdsid}\n` +
                        `Current Role Id: ${currentRoleId}\n` +
                        `Requested Role: ${roleName} (Id: ${roleId})\n\n` +
                        `Please approve or advise.\n\nRegards,\n${userIdsid}`
                    );
                    const cc = encodeURIComponent('nsihant.patil@intel.com');
                    const mailto = `mailto:${managerEmail}?subject=${subject}&cc=${cc}&body=${body}`;

                    // Close the modal before opening the mail client
                    const modalEl = document.getElementById('applyAccessModal');
                    if (modalEl && window.bootstrap && bootstrap.Modal){
                        const instance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                        instance.hide();
                    }

                    window.location.href = mailto;
                });
            })();
        </script>
    }
    else
    {
        
    
    <div class="card mb-4">
        <div class="card-body">
            <h1 class="h3 mb-3">Temporary Design Ownership Transfer</h1>

            <form method="post">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="Idsid" class="form-label">Idsid</label>
                        <select required id="Idsid" class="form-select" asp-for="SelectedIdsid">
                            <option value="" disabled selected>Select a user</option>
                            @foreach (var u in Model.AllUsers)
                            {
                                if (u.idsid == Model.CurrentIdsid)
                                {
                                    continue;
                                }
                                <option value="@u.idsid">@u.idsid</option>
                            }
                        </select>
                        <span class="text-danger small" asp-validation-for="SelectedIdsid"></span>
                    </div>
                    <div class="col-md-6">
                        <label for="DesignId" class="form-label">Design</label>
                        <select required id="DesignId" class="form-select" asp-for="SelectedDesignId">
                            <option value="" disabled selected>Select a design</option>
                            @foreach (var d in Model.OwnedDesigns)
                            {
                                <option value="@d.DesignId">@d.DesignName (@d.Platform, @d.SKU)</option>
                            }
                        </select>
                        <span class="text-danger small" asp-validation-for="SelectedDesignId"></span>
                    </div>
                    <div class="col-md-3">
                        <label for="StartDate" class="form-label">Start Date</label>
                        <input required id="StartDate" type="date" class="form-control" asp-for="StartDate" />
                        <span class="text-danger small" asp-validation-for="StartDate"></span>
                    </div>
                    <div class="col-md-3">
                        <label for="EndDate" class="form-label">End Date</label>
                        <input required id="EndDate" type="date" class="form-control" asp-for="EndDate" />
                        <span class="text-danger small" asp-validation-for="EndDate"></span>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <div class="card">
        <div class="card-body">
            <h2 class="h5 mb-3">Your Secondary Assignments</h2>
            @if (Model.MySecondaryOwners?.Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Design</th>
                                <th>Secondary Idsid</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var s in Model.MySecondaryOwners)
                            {
                                var design = Model.OwnedDesigns.FirstOrDefault(d => d.DesignId == s.DesignId);
                                <tr>
                                    <td>@(design != null ? $"{design.DesignName} ({design.Platform}, {design.SKU})" : s.DesignId.ToString())</td>
                                    <td>@s.SecondaryIdsid</td>
                                    <td>@s.StartDate.ToString("yyyy-MM-dd")</td>
                                    <td>@s.EndDate.ToString("yyyy-MM-dd")</td>
                                    <td class="text-center">
                                        <form method="post" asp-page-handler="DeleteSecondary" asp-route-designId="@s.DesignId" class="d-inline">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Remove this secondary assignment?');">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-muted">No secondary users assigned yet.</div>
            }
        </div>
    </div>
    }
</div>
